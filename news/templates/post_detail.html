{% load static %}
{% block body %}

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
 <link rel="icon" type="image/png" href="{% static 'images/logo2.png' %}">
  <title>News Portal – Post Details</title>

  <!-- Bootstrap 5 + FA6 + SweetAlert2 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
  <script defer src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- CKEditor 4 LTS (toolbar fix via base path) -->
  <script>
    window.CKEDITOR_BASEPATH = 'https://cdn.ckeditor.com/4.14.1/standard/';
  </script>
  <script src="https://cdn.ckeditor.com/4.25.1/standard/ckeditor.js"></script>

  <style>
    :root{ --ink:#0f172a; --muted:#64748b; --primary:#0ea5e9; --primary-2:#0369a1; }
    body{ background:#f8fafc; color:var(--ink); }
    .with-sidebar{ margin-left:260px; transition:margin-left .2s ease; }
    body.sidebar-collapsed .with-sidebar{ margin-left:76px; }

    .card-glass{ border:0; border-radius:1rem; background:#fff; box-shadow:0 12px 34px rgba(15,23,42,.12); }
    .form-floating>label{ color:var(--muted); }
    .img-preview{ width:100%; max-width:240px; height:160px; object-fit:cover; border-radius:.75rem; border:1px solid #e2e8f0; }
    .help-text{ color:var(--muted); }
  </style>
</head>
<body>

  {% include 'sidebar.html' %}
  {% include 'admin_nav.html' %}

  <!-- Main -->
  <main id="main-container" class="with-sidebar">
    <div class="container-fluid py-4 py-lg-5">

      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-4">
        <h1 class="h4 mb-0" style="color:var(--primary-2)">
          <i class="fa-regular fa-pen-to-square me-2"></i> Post Details
        </h1>
        <div class="d-flex gap-2">
          <a href="{% url 'view_post' %}" class="btn btn-sm btn-outline-primary">
            <i class="fa-solid fa-list me-1"></i> Manage Posts
          </a>
        </div>
      </div>

      <div class="card card-glass">
        <div class="card-body p-4 p-md-5">
          <form method="post" enctype="multipart/form-data" id="editPostForm" novalidate>
            {% csrf_token %}

            <!-- Title -->
            <div class="form-floating mb-3">
              <input type="text" class="form-control" id="posttitle" name="posttitle"
                     placeholder="Post Title" value="{{ newspost.posttitle }}" required minlength="3" maxlength="140">
              <label for="posttitle"><i class="fa-solid fa-heading me-1"></i> Post Title</label>
            </div>

            <!-- Category -->
            <div class="mb-3">
              <label for="categoryname" class="form-label fw-semibold">
                <i class="fa-solid fa-folder-tree me-1"></i> Category
              </label>
              <select name="categoryname" id="categoryname" class="form-select" required>
                <option value="{{ newspost.category.categoryname }}">{{ newspost.category.categoryname }}</option>
                {% for i in category %}
                  <option value="{{ i.categoryname }}">{{ i.categoryname }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Content -->
            <div class="mb-3">
              <label for="postdetail" class="form-label fw-semibold">
                <i class="fa-regular fa-file-lines me-1"></i> Post Detail
              </label>
              <textarea class="form-control" id="postdetail" name="postdetail" rows="7" required>{{ newspost.postdetail }}</textarea>
              <div class="help-text">Tip: keep paragraphs short; add sub-headings.</div>
            </div>

            <!-- Images -->
            <div class="row g-3 align-items-end">
              <div class="col-md-6">
                <label for="postimage" class="form-label fw-semibold">
                  <i class="fa-regular fa-image me-1"></i> Replace Feature Image (optional)
                </label>
                <input type="file" class="form-control" id="postimage" name="postimage" accept="image/*">
                <div class="help-text">JPG/PNG/WebP. ~2MB recommended.</div>
              </div>
              <div class="col-md-6">
                <div class="d-flex gap-3">
                  <div>
                    <div class="small text-muted mb-1">Current</div>
                    {% if newspost.postimage %}
                      <img src="{{ newspost.postimage.url }}" class="img-preview" alt="Current image">
                    {% else %}
                      <div class="text-muted">—</div>
                    {% endif %}
                  </div>
                  <div>
                    <div class="small text-muted mb-1">Preview</div>
                    <img id="imagePreview" class="img-preview" style="display:none" alt="Preview">
                  </div>
                </div>
              </div>
            </div>

            <div class="d-flex justify-content-end mt-4">
              <button type="submit" class="btn btn-primary">
                <i class="fa-solid fa-floppy-disk me-1"></i> Update
              </button>
            </div>
          </form>
        </div>
      </div>

    </div>
    {% include 'adminfooter.html' %}
  </main>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  (function ready(fn){
    if (document.readyState !== 'loading') fn();
    else document.addEventListener('DOMContentLoaded', fn);
  })(function(){

    // CKEditor init (guarantee after script load)
    function initEditor(){
      if (!window.CKEDITOR) return;
      if (CKEDITOR.instances.postdetail) return;
      CKEDITOR.replace('postdetail', {
        height: 300,
        removePlugins: 'elementspath',
        resize_enabled: false
      });
    }
    if (window.CKEDITOR) {
      if (CKEDITOR.status === 'loaded') initEditor();
      else CKEDITOR.on('loaded', initEditor);
    }

    // Image preview
    const input = document.getElementById('postimage');
    const preview = document.getElementById('imagePreview');
    input.addEventListener('change', function(){
      const f = this.files && this.files[0];
      if(!f){ preview.style.display='none'; preview.src=''; return; }
      if(!/^image\//.test(f.type)) { this.value=''; Swal.fire({icon:'error', title:'Invalid file'}); return; }
      if(f.size > 2*1024*1024){ this.value=''; Swal.fire({icon:'error', title:'File too large', text:'Max ~2MB recommended.'}); return; }
      const url = URL.createObjectURL(f);
      preview.src = url;
      preview.style.display = 'block';
    });

    // Client checks + prevent double submit
    const form = document.getElementById('editPostForm');
    form.addEventListener('submit', function(e){
      const t = document.getElementById('posttitle').value.trim();
      const c = document.getElementById('categoryname').value.trim();
      let content = '';
      if (window.CKEDITOR && CKEDITOR.instances.postdetail) {
        content = CKEDITOR.instances.postdetail.getData().trim();
      } else {
        content = (document.getElementById('postdetail').value||'').trim();
      }
      if (t.length < 3){ e.preventDefault(); Swal.fire({icon:'error', title:'Enter a valid title'}); return; }
      if (!c){ e.preventDefault(); Swal.fire({icon:'error', title:'Choose a category'}); return; }
      if (content.length < 10){ e.preventDefault(); Swal.fire({icon:'error', title:'Content too short'}); return; }
      form.querySelector('button[type="submit"]')?.setAttribute('disabled','disabled');
    });

    // Server feedback via context var `error`
    {% if error == "no" %}
      Swal.fire({
        icon: 'success',
        title: 'Record updated',
        showConfirmButton: false,
        timer: 1200,
        timerProgressBar: true
      }).then(()=>{ window.location = "{% url 'view_post' %}"; });
    {% elif error == "yes" %}
      Swal.fire({ icon:'error', title:'Something went wrong', text:'Please try again.' });
    {% endif %}

  });
  </script>
</body>
</html>

{% endblock %}
