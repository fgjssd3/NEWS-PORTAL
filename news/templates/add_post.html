{% load static %}
{% block body %}

<!doctype html>
<html lang="en">
<head>
  <script>
setTimeout(() => location.reload(true), 30000);
</script>
  <meta charset="utf-8"/>
  <meta http-equiv="Cache-Control" content="no-cache">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
 <link rel="icon" type="image/png" href="{% static 'images/logo2.png' %}">
  <title>News Portal – Add Post</title>

  <!-- Bootstrap 5 + FA6 + SweetAlert2 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
  <script defer src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- CKEditor 4 (as you had) -->
  <script defer src="https://cdn.ckeditor.com/4.14.1/standard/ckeditor.js"></script>

  <style>
    :root{ --ink:#0f172a; --muted:#64748b; --primary:#0ea5e9; --primary-2:#0369a1; --danger:#ef4444; }
    body{ background:#f8fafc; color:var(--ink); }

    /* layout with our new sidebar */
    .with-sidebar{ margin-left:260px; transition:margin-left .2s ease; }
    body.sidebar-collapsed .with-sidebar{ margin-left:76px; }

    .card-glass{
      border:0; border-radius:1rem; background:#fff;
      box-shadow:0 12px 34px rgba(15,23,42,.12);
    }
    .form-floating>label{ color:var(--muted); }

    .input-help{ color:var(--muted); }
    .img-preview{
      border-radius:.75rem; width:100%; height:220px; object-fit:cover; display:none;
      border:1px dashed #cbd5e1;
    }
    .ck-editor__editable{ min-height: 220px; } /* if switching to CKEditor5 later */
  </style>
</head>
<body>

  {% include 'sidebar.html' %}
  {% include 'admin_nav.html' %}

  <!-- Main -->
  <main id="main-container" class="with-sidebar">
    <div class="container-fluid py-4 py-lg-5">

      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-4">
        <h1 class="h4 mb-0" style="color:var(--primary-2)">
          <i class="fa-regular fa-newspaper me-2"></i> Add Post
        </h1>
        <div class="d-flex gap-2">
          <a href="{% url 'view_post' %}" class="btn btn-sm btn-outline-primary">
            <i class="fa-solid fa-list me-1"></i> Manage Posts
          </a>
        </div>
      </div>

      <div class="row g-4">
        <!-- Form column -->
        <div class="col-lg-8">
          <div class="card card-glass">
            <div class="card-body p-4 p-md-5">
              <h2 class="h6 mb-3">Create a new post</h2>
              <p class="text-muted mb-4">Fill the details below. Feature image should be landscape (preferably 16:9).</p>

              <form method="post" enctype="multipart/form-data" id="addPostForm" novalidate>
                {% csrf_token %}

                <!-- Title -->
                <div class="form-floating mb-3">
                  <input type="text" class="form-control" id="posttitle" name="posttitle"
                         placeholder="Post Title" required minlength="3" maxlength="140">
                  <label for="posttitle"><i class="fa-solid fa-heading me-1"></i> Post Title</label>
                </div>

                <!-- Category -->
                <div class="mb-3">
                  <label for="categoryname" class="form-label fw-semibold">
                    <i class="fa-solid fa-folder-tree me-1"></i> Category
                  </label>
                  <select class="form-select" id="categoryname" name="categoryname" required>
                    <option value="">--Choose Category--</option>
                    {% for i in category %}
                      <option value="{{ i.categoryname }}">{{ i.categoryname }}</option>
                    {% endfor %}
                  </select>
                </div>

                <!-- Content -->
                <div class="mb-3">
                  <label for="postdetail" class="form-label fw-semibold">
                    <i class="fa-regular fa-file-lines me-1"></i> Post Details
                  </label>
                  <textarea class="form-control" id="postdetail" name="postdetail" required rows="6"></textarea>
                  <div class="form-text input-help">Tip: add subheadings and short paragraphs for readability.</div>
                </div>

                <!-- Feature Image -->
                <div class="mb-3">
                  <label for="postimage" class="form-label fw-semibold">
                    <i class="fa-regular fa-image me-1"></i> Feature Image
                  </label>
                  <input type="file" class="form-control" id="postimage" name="postimage" accept="image/*" required>
                  <div class="form-text input-help">Max ~2MB recommended. JPG/PNG/WebP.</div>
                </div>
                <img id="imagePreview" class="img-preview mt-2" alt="Preview"/>

                <div class="d-grid mt-4">
                  <button type="submit" class="btn btn-primary">
                    <i class="fa-solid fa-plus me-1"></i> Add
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Tips / Info -->
        <div class="col-lg-4">
          <div class="card card-glass">
            <div class="card-body p-4 p-md-5">
              <h2 class="h6 mb-3"><i class="fa-solid fa-lightbulb me-2"></i> Tips</h2>
              <ul class="mb-0 text-muted">
                <li>Title under 80–100 characters works best.</li>
                <li>Use a high-contrast feature image (min 1200×675).</li>
                <li>Pick the most specific category available.</li>
                <li>Break content with subheads and bullet lists.</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

    </div>

    {% include 'adminfooter.html' %}
  </main>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ensure SweetAlert & CKEditor are loaded (they're deferred)
    window.addEventListener('DOMContentLoaded', function(){
        
      // Init CKEditor 4 for textarea
      if (window.CKEDITOR && !CKEDITOR.instances.postdetail) {

        // turn off version check
      CKEDITOR.config.versionCheck = false;
        CKEDITOR.replace('postdetail');
      }

      // Simple client-side checks
      const form = document.getElementById('addPostForm');
      const title = document.getElementById('posttitle');
      const cat = document.getElementById('categoryname');
      const img = document.getElementById('postimage');
      const preview = document.getElementById('imagePreview');

      // Image preview
      img.addEventListener('change', function(){
        const f = this.files && this.files[0];
        if(!f){ preview.style.display = 'none'; preview.src = ''; return; }
        // basic type/size check (2MB)
        const okType = /^image\//.test(f.type);
        const okSize = f.size <= 2 * 1024 * 1024; // 2MB
        if(!okType){
          this.value = '';
          preview.style.display = 'none';
          Swal.fire({icon:'error', title:'Invalid file', text:'Please choose a valid image.'});
          return;
        }
        if(!okSize){
          this.value = '';
          preview.style.display = 'none';
          Swal.fire({icon:'error', title:'File too large', text:'Max recommended size is 2MB.'});
          return;
        }
        const url = URL.createObjectURL(f);
        preview.src = url;
        preview.style.display = 'block';
      });

      // Submit validation; read CKEditor data
      form.addEventListener('submit', function(e){
        const t = title.value.trim();
        const c = cat.value.trim();
        let content = '';
        if (window.CKEDITOR && CKEDITOR.instances.postdetail) {
          content = CKEDITOR.instances.postdetail.getData().trim();
        } else {
          content = (document.getElementById('postdetail').value || '').trim();
        }

        if (t.length < 3){
          e.preventDefault();
          Swal.fire({icon:'error', title:'Enter a valid title', text:'Title must be at least 3 characters.'});
          return;
        }
        if (!c){
          e.preventDefault();
          Swal.fire({icon:'error', title:'Choose a category'});
          return;
        }
        if (content.length < 10){
          e.preventDefault();
          Swal.fire({icon:'error', title:'Add some content', text:'Post details look too short.'});
          return;
        }

        // prevent double submit
        form.querySelector('button[type="submit"]')?.setAttribute('disabled','disabled');
      });

      // Server feedback via context var `error`
      {% if error == "no" %}
        Swal.fire({
          icon: 'success',
          title: 'Post added',
          showConfirmButton: false,
          timer: 1200,
          timerProgressBar: true
        }).then(()=>{ window.location = "{% url 'view_post' %}"; });
      {% elif error == "yes" %}
        Swal.fire({ icon:'error', title:'Something went wrong', text:'Please try again.' });
      {% endif %}
    });
  </script>
</body>
</html>

{% endblock %}
